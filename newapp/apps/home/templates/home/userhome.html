{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <title>Document</title>
</head>
<body>
    welcome {{ username }} <br>
    <a href="/home/login/upload/"><button>Upload Post</button></a>
    <a href="/home/logout/"><button>Logout</button></a>
    <a href="/home/login/mypost/"><button>My Posts</button></a>
    <a href="/home/profile/"><button>Profile</button></a>
    <a href="/home/notify/"><button>Notifications</button></a>

    <br><br>

    <form action="/home/search/"  method="get">
        <input type="text" name="searchuser" placeholder="Search User">  <br>
        <button type="submit">Submit</button>
    </form>
    <br>
    <br>
    <br>
    <h1>feed</h1>
    {% for post in posts %}
        By:- {{post.user.username}} <br>
        Tagline:- {{post.tagline}} <br><br>

        {% ifequal post.posttype "image" %}
            <img src="{{post.video.url}}" width="320px" height ="200px" alt="Not Found">
            <br>
        
        {% else %}
            <a href="{% url 'playvideo' post.id %}"><button>Play Video</button></a>

        {% endifequal %}

        <br>

        {% if post in liked_posts %}
        
    <button id ="{{post.id}}" class="lol"><a href="{%url 'like_post' %}" id="hlike{{post.id}}">Dislike</a></button>
        {%else%}
    <button id ="{{post.id}}" class="lol"><a href="{%url 'like_post' %}" id="hlike{{post.id}}">Like</a></button> 
        {%endif%}
           <a class="count" id="count{{post.id}}">{{post.likes.count}}</a><br><br>

           {% if post not in rated_posts %}
           <div id="rate{{post.id}}">
            <input type="radio" name="rate{{post.id}}" value="1" id="1"  > 
            <input type="radio" name="rate{{post.id}}" value="2" id="2"  >
            <input type="radio" name="rate{{post.id}}" value="3" id="3"  >
            <input type="radio" name="rate{{post.id}}" value="4" id="4"  >
            <input type="radio" name="rate{{post.id}}" value="5" id="5"  >

        </div>
            <button class="rating" id="x{{post.id}}" ><a href="{% url 'rating' %}" class="{{post.id}}"><span id="text{{post.id}}"> Rate </span></a></button>
            {% else %}
                <button>Rated</button>
            {% endif %}
            <span id="avg{{post.id}}">{{post.avgRating}}</span><br>

            {% if post in reported_posts %}
            <button>Reported</button>

            {% else %}
            <button class="report" id="r{{post.id}}"><a href="{% url 'report' %}" class="{{post.id}}" id="report{{post.id}}">
                <span id="s{{post.id}}">Report</span></a></button>

            {% endif %}


    {%for comment in comments%}
    {%if post.id == comment.post.id%}
    <pre>{{comment.user.username}} at {{comment.time}} :{{comment.comment}}</pre><hr>
    {%endif%}
    {%endfor%}
    <span id="end{{post.id}}"></span> <br>

    <textarea id="cmnt{{post.id}}"  name="comment{{post.id}}" style="resize:none;width:400px;"></textarea>
    <button id="{{post.id}}" class="Commentbtn">Comment</button>
           <br><br><br>
    {% endfor %}


    <script>
     $(".Commentbtn").click(
    function(e){
    href="{% url 'comment_post'%}"
    var id=this.id;
    var msg=$("#cmnt"+id).val();
    $("#cmnt"+id).val("");

    e.preventDefault();
    console.log(id,msg)
    $.ajax({
    url: href,
    data:{'comment':msg,
           'postid':id},
    success:function(response){
        $("#end"+id).append(response.username+"at"+response.time+" :"+response.comment+"<hr>")

    }
    })


    }
    );
        $(".lol").click(
               function(e){
               var id =this.id;
       
               var href=$('.lol').find('a').attr('href')
               console.log(href,id)
               e.preventDefault();
        $.ajax({
                   url:href,
                   data : {'likeid':id},
                   success:function(response){
                     $('#count'+id).html(response.count)
                       if(response.liked){
                       $('#hlike'+id).html("Like")   //  find('a')finds button with id=post id and since href has our html so we have to find anchor tag a and then use html,try doing this oppositely:by parag
       
                       //'#' is used for refering 'id' while '.' is used for finding key words in 'class' (can be any keyword or keywrds present in class but try to make it unique)
                       }else{
                            $('#hlike'+id).html("Dislike")
                       }
                   }
               })
               }
               );

               $(".report").click(
                   function(e){
                        var id = $(this).find('a').attr('class');
                        var href = $('.report').find('a').attr('href');
                        console.log(href,id)
                        e.preventDefault();
                
                $.ajax({
                    url:href,
                    data : {'postid':id},
                    success:function(response){
                       
                       $('#r'+id).find('a').remove();
                       $('#r'+id).html("Reported");

                    }
                    
                })
                   }
               );


               $(".rating").click(
               function(e){
                   var id = $(this).find('a').attr('class');
                   var href = $(this).find('a').attr('href');
                   
                   var x = $('#rate'+id).find('input');

                   var i,gotValue;
                   for(i=0;i<5;i++)
                    {
                        if(x[i].checked)
                        {
                            gotValue=x[i].value;
                            break;
                        }
                    }
                    e.preventDefault();

                    console.log(gotValue)

                    $.ajax({
                   url:href,
                   data : {'rateid':id , 'value':gotValue},
                   success:function(response){
                     // will write ajax here...pls wait
                     $('#avg'+id).html(response.avg)
                     $('#rate'+id).remove();
                     $('#x'+id).find('a').remove();
                     $('#x'+id).html("Rated");
                   }
               })
               
               }
               );
               
               </script>
       
       
</body>
</html>